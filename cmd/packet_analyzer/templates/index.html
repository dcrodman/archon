<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<title>packet diff</title>
<style type="text/css">
	table.diff{border-collapse:collapse;border:1px solid #a9a9a9;white-space:pre-wrap}table.diff tbody{font-family:Courier,monospace}table.diff tbody th{font-family:verdana,arial,'Bitstream Vera Sans',helvetica,sans-serif;background:#eed;font-size:11px;font-weight:400;border:1px solid #bbc;color:#886;padding:.3em .5em .1em 2em;text-align:right;vertical-align:top}table.diff thead{border-bottom:1px solid #bbc;background:#efefef;font-family:Verdana}table.diff thead th.texttitle{text-align:left}table.diff tbody td{padding:0 .4em;padding-top:.4em;vertical-align:top}table.diff .empty{background-color:#ddd}table.diff .replace{background-color:#fd8}table.diff .delete{background-color:#e99}table.diff .skip{background-color:#efefef;border:1px solid #aaa;border-right:1px solid #bbc}table.diff .insert{background-color:#9e9}table.diff th.author{text-align:right;border-top:1px solid #bbc;background:#efefef}
</style>
	<script type="text/javascript">
		var diffview={buildView:function(e){var t=e.baseTextLines,n=e.newTextLines,d=e.opcodes,a=e.baseTextName?e.baseTextName:"Base Text",i=e.newTextName?e.newTextName:"New Text",l=e.contextSize,h=0==e.viewType||1==e.viewType?e.viewType:0;if(null==t)throw"Cannot build diff view; baseTextLines is not defined.";if(null==n)throw"Cannot build diff view; newTextLines is not defined.";if(!d)throw"Canno build diff view; opcodes is not defined.";function p(e,t){var n=document.createElement(e);return n.className=t,n}function r(e,t){var n=document.createElement(e);return n.appendChild(document.createTextNode(t)),n}function c(e,t,n){var d=document.createElement(e);return d.className=t,d.appendChild(document.createTextNode(n)),d}var o=document.createElement("thead"),u=document.createElement("tr");o.appendChild(u),h?(u.appendChild(document.createElement("th")),u.appendChild(document.createElement("th")),u.appendChild(c("th","texttitle",a+" vs. "+i))):(u.appendChild(document.createElement("th")),u.appendChild(c("th","texttitle",a)),u.appendChild(document.createElement("th")),u.appendChild(c("th","texttitle",i))),o=[o];var f,m=[];function s(e,t,n,d,a){return t<n?(e.appendChild(r("th",(t+1).toString())),e.appendChild(c("td",a,d[t].replace(/\t/g,"    "))),t+1):(e.appendChild(document.createElement("th")),e.appendChild(p("td","empty")),t)}function C(e,t,n,d,a){e.appendChild(r("th",null==t?"":(t+1).toString())),e.appendChild(r("th",null==n?"":(n+1).toString())),e.appendChild(c("td",a,d[null!=t?t:n].replace(/\t/g,"    ")))}for(var g=0;g<d.length;g++){code=d[g],change=code[0];for(var v=code[1],w=code[2],b=code[3],x=code[4],T=Math.max(w-v,x-b),E=[],N=[],y=0;y<T;y++){if(l&&d.length>1&&(g>0&&y==l||0==g&&0==y)&&"equal"==change){var k=T-(0==g?1:2)*l;if(k>1){if(E.push(u=document.createElement("tr")),v+=k,b+=k,y+=k-1,u.appendChild(r("th","...")),h||u.appendChild(c("td","skip","")),u.appendChild(r("th","...")),u.appendChild(c("td","skip","")),g+1==d.length)break;continue}}E.push(u=document.createElement("tr")),h?"insert"==change?C(u,null,b++,n,change):"replace"==change?(N.push(f=document.createElement("tr")),v<w&&C(u,v++,null,t,"delete"),b<x&&C(f,null,b++,n,"insert")):"delete"==change?C(u,v++,null,t,change):C(u,v++,b++,t,change):(v=s(u,v,w,t,change),b=s(u,b,x,n,change))}for(y=0;y<E.length;y++)m.push(E[y]);for(y=0;y<N.length;y++)m.push(N[y])}for(var g in m.push(u=c("th","author","diff view generated by ")),u.setAttribute("colspan",h?3:4),u.appendChild(f=r("a","jsdifflib")),f.setAttribute("href","http://github.com/cemerick/jsdifflib"),o.push(u=document.createElement("tbody")),m)m.hasOwnProperty(g)&&u.appendChild(m[g]);for(var g in u=p("table","diff"+(h?" inlinediff":"")),o)o.hasOwnProperty(g)&&u.appendChild(o[g]);return u}};
	</script>
	<script type="text/javascript">
		var __whitespace={" ":!0,"\t":!0,"\n":!0,"\f":!0,"\r":!0},difflib={defaultJunkFunction:function(t){return __whitespace.hasOwnProperty(t)},stripLinebreaks:function(t){return t.replace(/^[\n\r]*|[\n\r]*$/g,"")},stringAsLines:function(t){for(var i=t.indexOf("\n"),n=t.indexOf("\r"),e=i>-1&&n>-1||n<0?"\n":"\r",s=t.split(e),h=0;h<s.length;h++)s[h]=difflib.stripLinebreaks(s[h]);return s},__reduce:function(t,i,n){if(null!=n)var e=n,s=0;else{if(!i)return null;e=i[0],s=1}for(;s<i.length;s++)e=t(e,i[s]);return e},__ntuplecomp:function(t,i){for(var n=Math.max(t.length,i.length),e=0;e<n;e++){if(t[e]<i[e])return-1;if(t[e]>i[e])return 1}return t.length==i.length?0:t.length<i.length?-1:1},__calculate_ratio:function(t,i){return i?2*t/i:1},__isindict:function(t){return function(i){return t.hasOwnProperty(i)}},__dictget:function(t,i,n){return t.hasOwnProperty(i)?t[i]:n},SequenceMatcher:function(t,i,n){this.set_seqs=function(t,i){this.set_seq1(t),this.set_seq2(i)},this.set_seq1=function(t){t!=this.a&&(this.a=t,this.matching_blocks=this.opcodes=null)},this.set_seq2=function(t){t!=this.b&&(this.b=t,this.matching_blocks=this.opcodes=this.fullbcount=null,this.__chain_b())},this.__chain_b=function(){for(var t=this.b,i=t.length,n=this.b2j={},e={},s=0;s<t.length;s++){var h=t[s];if(n.hasOwnProperty(h)){var r=n[h];i>=200&&100*r.length>i?(e[h]=1,delete n[h]):r.push(s)}else n[h]=[s]}for(var h in e)e.hasOwnProperty(h)&&delete n[h];var a=this.isjunk,u={};if(a){for(var h in e)e.hasOwnProperty(h)&&a(h)&&(u[h]=1,delete e[h]);for(var h in n)n.hasOwnProperty(h)&&a(h)&&(u[h]=1,delete n[h])}this.isbjunk=difflib.__isindict(u),this.isbpopular=difflib.__isindict(e)},this.find_longest_match=function(t,i,n,e){for(var s,h=this.a,r=this.b,a=this.b2j,u=this.isbjunk,l=t,o=n,f=0,c=null,_={},b=[],g=t;g<i;g++){var p={},d=difflib.__dictget(a,h[g],b);for(var m in d)if(d.hasOwnProperty(m)){if((c=d[m])<n)continue;if(c>=e)break;p[c]=s=difflib.__dictget(_,c-1,0)+1,s>f&&(l=g-s+1,o=c-s+1,f=s)}_=p}for(;l>t&&o>n&&!u(r[o-1])&&h[l-1]==r[o-1];)l--,o--,f++;for(;l+f<i&&o+f<e&&!u(r[o+f])&&h[l+f]==r[o+f];)f++;for(;l>t&&o>n&&u(r[o-1])&&h[l-1]==r[o-1];)l--,o--,f++;for(;l+f<i&&o+f<e&&u(r[o+f])&&h[l+f]==r[o+f];)f++;return[l,o,f]},this.get_matching_blocks=function(){if(null!=this.matching_blocks)return this.matching_blocks;for(var t,i,n,e,s,h,r,a,u,l=this.a.length,o=this.b.length,f=[[0,l,0,o]],c=[];f.length;)t=(s=f.pop())[0],i=s[1],n=s[2],e=s[3],h=(u=this.find_longest_match(t,i,n,e))[0],r=u[1],(a=u[2])&&(c.push(u),t<h&&n<r&&f.push([t,h,n,r]),h+a<i&&r+a<e&&f.push([h+a,i,r+a,e]));c.sort(difflib.__ntuplecomp);var _,b,g,p=0,d=0,m=0,v=0,k=[];for(var q in c)c.hasOwnProperty(q)&&(_=(v=c[q])[0],b=v[1],g=v[2],p+m==_&&d+m==b?m+=g:(m&&k.push([p,d,m]),p=_,d=b,m=g));return m&&k.push([p,d,m]),k.push([l,o,0]),this.matching_blocks=k,this.matching_blocks},this.get_opcodes=function(){if(null!=this.opcodes)return this.opcodes;var t,i,n,e,s,h=0,r=0,a=[];this.opcodes=a;var u=this.get_matching_blocks();for(var l in u)u.hasOwnProperty(l)&&(i=(t=u[l])[0],n=t[1],e=t[2],s="",h<i&&r<n?s="replace":h<i?s="delete":r<n&&(s="insert"),s&&a.push([s,h,i,r,n]),h=i+e,r=n+e,e&&a.push(["equal",i,h,n,r]));return a},this.get_grouped_opcodes=function(t){t||(t=3);var i,n,e,s,h,r,a=this.get_opcodes();a||(a=[["equal",0,1,0,1]]),"equal"==a[0][0]&&(n=(i=a[0])[0],e=i[1],s=i[2],h=i[3],r=i[4],a[0]=[n,Math.max(e,s-t),s,Math.max(h,r-t),r]),"equal"==a[a.length-1][0]&&(n=(i=a[a.length-1])[0],e=i[1],s=i[2],h=i[3],r=i[4],a[a.length-1]=[n,e,Math.min(s,e+t),h,Math.min(r,h+t)]);var u=t+t,l=[],o=[];for(var f in a)a.hasOwnProperty(f)&&(n=(i=a[f])[0],e=i[1],s=i[2],h=i[3],r=i[4],"equal"==n&&s-e>u&&(l.push([n,e,Math.min(s,e+t),h,Math.min(r,h+t)]),o.push(l),l=[],e=Math.max(e,s-t),h=Math.max(h,r-t)),l.push([n,e,s,h,r]));return!l||1==l.length&&"equal"==l[0][0]||o.push(l),o},this.ratio=function(){return matches=difflib.__reduce(function(t,i){return t+i[i.length-1]},this.get_matching_blocks(),0),difflib.__calculate_ratio(matches,this.a.length+this.b.length)},this.quick_ratio=function(){var t,i;if(null==this.fullbcount){this.fullbcount=t={};for(var n=0;n<this.b.length;n++)t[i=this.b[n]]=difflib.__dictget(t,i,0)+1}t=this.fullbcount;var e={},s=difflib.__isindict(e),h=numb=0;for(n=0;n<this.a.length;n++)s(i=this.a[n])?numb=e[i]:numb=difflib.__dictget(t,i,0),e[i]=numb-1,numb>0&&h++;return difflib.__calculate_ratio(h,this.a.length+this.b.length)},this.real_quick_ratio=function(){var t=this.a.length,i=this.b.length;return _calculate_ratio(Math.min(t,i),t+i)},this.isjunk=n||difflib.defaultJunkFunction,this.a=this.b=null,this.set_seqs(t,i)}};
	</script>
<style type="text/css">
body {
	font-size: 12px;
	font-family: Sans-Serif;
}
button {
	margin: 5px;
	text-align: center;
}
.textInput {
	display: block;
	width: 49%;
	float: left;
}
textarea {
	width:100%;
	height:200px;
}
label:hover {
	text-decoration: underline;
	cursor: pointer;
}
.spacer {
	margin-left: 10px;
}
.viewType {
	text-align: center;
}
#diffoutput {
	width: 100%;
}
</style>

<script type="text/javascript">

const host = 'http://localhost:8083'

function byId(id) {
	return document.getElementById(id);
}

function diffUsingJS(viewType) {
	let base = difflib.stringAsLines(byId('base').value);
	let	newtxt = difflib.stringAsLines(byId('new').value);
	let	sm = new difflib.SequenceMatcher(base, newtxt);
	let	opcodes = sm.get_opcodes();
	let	diffoutputdiv = byId('diffoutput');
	let	contextSize = byId('contextSize').value;

	contextSize = contextSize || null;
	diffoutputdiv.innerHTML = ''
	diffoutputdiv.appendChild(diffview.buildView({
		baseTextLines: base,
		newTextLines: newtxt,
		opcodes: opcodes,
		baseTextName: 'Base',
		newTextName: 'New',
		contextSize: contextSize,
		viewType: viewType
	}));
}

function loadSession(sessionSelectId, id, checkId) {
	fetch(host + '/?session=' + byId(sessionSelectId).value)
	.then(response => response.text())
	.then(data => {
		byId(id).value = data
		checkAndDiff(checkId)
	})
}

function loadFromFileListener(fileInputId, textId, checkId) {
	byId(fileInputId)
		.addEventListener('change', function() {
			const fr = new FileReader();
			fr.onload = function(){
				byId(textId).value = fr.result
				checkAndDiff(checkId)
			}
			fr.readAsText(this.files[0]);
		})
}

function checkAndDiff(checkId) {
	// Auto generate diff if both filled
	if (byId(checkId).value) {
		diffUsingJS(0)
	}
}

function createSelect(id, parentId, sessions) {
	//Create array of options to be added
	let selectList = document.createElement('select');
	selectList.id = id;
	byId(parentId).appendChild(selectList);

	for (let i = 0; i < sessions.length; i++) {
		let option = document.createElement('option');
		option.value = sessions[i];
		option.text = sessions[i];
		selectList.appendChild(option);
	}
}

function deleteAllSessions() {
	fetch(host + '/', {method: 'DELETE'})
}

window.addEventListener('load', function() {
	loadFromFileListener('base-file', 'base', 'new')
	loadFromFileListener('new-file', 'new', 'base')

	fetch(host + '/')
		.then(response => response.json())
		.then(sessions => {
			createSelect('base-select', 'base-select-parent', sessions)
			createSelect('new-select', 'new-select-parent', sessions)
		})
})
</script>
</head>
<body>
	<div class="textInput">
		<div class="buttons">
			Load from file: <input id="base-file" type="file"/>
			<span id="base-select-parent"></span>
			<button onclick="loadSession('base-select', 'base', 'new')">Load selected</button>
		</div>
		<textarea id="base"></textarea>
	</div>
	<div class="textInput spacer">
		<div class="buttons">
			Load from file: <input id="new-file" type="file"/>
			<span id="new-select-parent"></span>
			<button onclick="loadSession('new-select', 'new', 'base')">Load selected</button>
		</div>
		<textarea id="new"></textarea>
	</div>
	<div class="viewType">
		<strong>Generate Diff:</strong>
		<button onclick="diffUsingJS(0);">Side by Side</button>
		<button onclick="diffUsingJS(1);">Inline</button>

		<strong>Context size (optional):</strong>
		<input type="text" id="contextSize" value="" />

		<button onclick="deleteAllSessions(1);">!!! Delete all sessions !!!</button>
	</div>
	<div id="diffoutput"></div>
</body>
</html>
